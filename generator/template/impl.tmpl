// Autogenerated by application-generator

package generated

import (
	"application-emulator/src/stressors"
	"application-emulator/src/util"
	model "application-model"
	"application-model/generated"
	"context"
	"errors"
	"log"

	"google.golang.org/grpc"
)

{{ range . }}
type {{ goname .Name }}Impl struct {
	Unimplemented{{ goname .Name }}Server
	{{ range .Endpoints }}
	{{ goname .Name }}Info *model.Endpoint
	{{ end }}
}
{{ end }}

{{ range $service := . }}
{{ range $endpoint := .Endpoints }}
func (s *{{ goname $service.Name }}Impl) {{ goname $endpoint.Name }}(ctx context.Context, request *generated.Request) (*generated.Response, error) {
	trace := util.TraceEndpointCall(s.{{ goname $endpoint.Name }}Info, "gRPC")
	response := &generated.Response{
		Endpoint: s.{{ goname $endpoint.Name }}Info.Name,
		Tasks:    stressors.Exec(request, s.{{ goname $endpoint.Name }}Info),
	}
	util.LogEndpointCall(trace)
	return response, nil
}
{{ end }}
{{ end }}

// Maps endpoint to a generated service struct and registers it with registrar
func RegisterGeneratedService(registrar grpc.ServiceRegistrar, endpoints []model.Endpoint) {
	switch util.ServiceName {
	{{ range . }}
	case "{{ .Name }}": 
		impl := {{ goname .Name }}Impl{}
		for _, endpoint := range endpoints {
			switch endpoint.Name {
			{{ range .Endpoints }}
			case "{{ .Name }}":
				impl.{{ goname .Name }}Info = &endpoint
			{{ end }}
			default:
				log.Fatalf("Service %s got invalid gRPC endpoint %s", util.ServiceName, endpoint.Name)
			}
		}
		Register{{ goname .Name }}Server(registrar, &impl)
	{{ end }}
	}
}

// Searches for method by service, endpoint and returns the result
func CallGeneratedEndpoint(ctx context.Context, cc grpc.ClientConnInterface, service, endpoint string, in *generated.Request) (*generated.Response, error) {
	options := []grpc.CallOption{}

	switch service {
	{{ range . }}
	case "{{ .Name }}": 
		client := New{{ goname .Name }}Client(cc)
		switch endpoint {
		{{ range .Endpoints }}
		case "{{ .Name }}":
			return client.{{ goname .Name }}(ctx, in, options...)
		{{ end }}
		}
	{{ end }}
	}

	return nil, errors.New("Unknown service, endpoint combination")
}